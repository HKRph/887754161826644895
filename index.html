<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Adventure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #2a2a2e);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-button: var(--tg-theme-button-color, #5a9cf8);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #3b3b42);
            --pixel-border: #1c1c1f;
            --accent-yellow: #f7d82e;
            --accent-green: #52f66e;
            --accent-red: #f85555;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toastIn { from { opacity: 0; bottom: -20px; } to { opacity: 1; bottom: 20px; } }
        @keyframes toastOut { to { opacity: 0; bottom: -20px; } }

        body {
            font-family: 'Press Start 2P', cursive;
            padding: 15px;
            margin: 0;
            color: var(--tg-text);
            background-color: var(--tg-bg);
            -webkit-font-smoothing: none;
            font-smooth: never;
            image-rendering: pixelated;
            animation: fadeIn 0.5s ease-out;
            overscroll-behavior-y: none;
        }

        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s; }
        .app-container { max-width: 420px; margin: 0 auto; }
        
        .header { text-align: left; margin-bottom: 20px; }
        .header h1 { font-size: 18px; line-height: 1.4; margin: 0 0 5px 0; }
        .header p { font-size: 10px; color: var(--tg-hint); margin: 0; }

        .pixel-card {
            background-color: var(--tg-secondary-bg);
            border: 2px solid var(--pixel-border);
            box-shadow: 4px 4px 0px var(--pixel-border);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .balance-card h2 { margin: 0 0 10px 0; font-size: 10px; text-transform: uppercase; color: var(--tg-hint); }
        .balance-card .balance-amount { font-size: 28px; color: var(--accent-yellow); line-height: 1; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .pixel-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px; background-color: var(--tg-secondary-bg);
            border: 2px solid var(--pixel-border);
            box-shadow: 4px 4px 0px var(--pixel-border);
            color: var(--tg-text); cursor: pointer; text-align: center;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .pixel-button:active { transform: translate(4px, 4px); box-shadow: none; }
        .button-icon { font-size: 24px; margin-bottom: 10px; }
        .button-text { font-size: 10px; }

        .back-button { font-size: 12px; cursor: pointer; margin-bottom: 15px; display: inline-block; }
        .back-button:active { transform: scale(0.95); }
        
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            background-color: var(--tg-secondary-bg);
            border: 2px solid var(--pixel-border);
            padding: 15px;
            margin-bottom: 15px;
        }
        .list-item h3 { margin: 0 0 8px 0; font-size: 10px; }
        .list-item p { margin: 0; font-size: 8px; color: var(--tg-hint); line-height: 1.5; }
        .list-item a { color: var(--tg-button); text-decoration: none; font-size: 10px; display: block; margin-top: 10px;}
        .withdrawal-item .status { float: right; font-weight: 600; font-size: 10px; }
        .status-pending { color: var(--accent-yellow); } .status-approved { color: var(--accent-green); } .status-rejected { color: var(--accent-red); }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-size: 10px; margin-bottom: 8px; }
        .form-group input, .method-selector button {
            width: 100%; padding: 12px; font-size: 12px; font-family: 'Press Start 2P', cursive;
            border: 2px solid var(--pixel-border); background-color: var(--tg-bg); color: var(--tg-text); box-sizing: border-box;
        }
        .method-selector { display: flex; gap: 10px; }
        .method-selector button.selected { background-color: var(--tg-text); color: var(--tg-bg); }

        /* Modal & Toast Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--tg-secondary-bg); padding: 20px; border: 2px solid var(--pixel-border); box-shadow: 4px 4px 0px var(--pixel-border); width: 90%; max-width: 350px; text-align: center; }
        .modal-content h2 { font-size: 14px; margin-top: 0; } .modal-content p { font-size: 10px; color: var(--tg-hint); line-height: 1.5; }
        .referral-link-box { background-color: var(--tg-bg); border: 2px solid var(--pixel-border); padding: 10px; word-wrap: break-word; margin: 20px 0; font-size: 10px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--tg-secondary-bg); color: var(--tg-text); padding: 15px; z-index: 2000; border: 2px solid var(--pixel-border); box-shadow: 4px 4px 0px var(--pixel-border); font-size: 10px; }
    </style>
</head>
<body>

    <div id="loadingView" class="loading-overlay" style="display: flex; position: fixed; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; background: var(--tg-bg); z-index: 9999; font-size: 12px;">Loading...</div>

    <!-- Main Dashboard View -->
    <div id="dashboardView" class="app-view active">
        <div class="app-container">
            <div class="header"> <h1 id="welcome-message">WELCOME PLAYER!</h1> <p>YOUR QUEST FOR REWARDS.</p> </div>
            <div class="pixel-card balance-card"> <h2>CURRENT BALANCE</h2> <p id="balanceAmount" class="balance-amount">‚Ç±--.--</p> </div>
            <div class="action-grid">
                <a id="tasksBtn" class="pixel-button"><div class="button-icon">üìú</div><div class="button-text">TASKS</div></a>
                <a id="withdrawBtn" class="pixel-button"><div class="button-icon">üí∏</div><div class="button-text">WITHDRAW</div></a>
                <a id="profileBtn" class="pixel-button"><div class="button-icon">üë§</div><div class="button-text">PROFILE</div></a>
                <a id="inviteBtn" class="pixel-button"><div class="button-icon">ü§ù</div><div class="button-text">INVITE</div></a>
            </div>
        </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="app-view">
        <div class="app-container">
            <a class="back-button" onclick="showView('dashboardView')">&lt; BACK</a>
            <div class="pixel-card">
                <h3 style="font-size: 10px;">PLAYER PROFILE</h3>
                <p id="profileName" style="font-size: 10px; line-height: 1.8;">NAME: ...</p>
                <p id="profileId" style="font-size: 10px; line-height: 1.8;">USER ID: ...</p>
                <p id="profileReferrals" style="font-size: 10px; line-height: 1.8;">REFERRED: ...</p>
            </div>
        </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="app-view">
        <div class="app-container">
            <a class="back-button" onclick="showView('dashboardView')">&lt; BACK</a>
            <h1 style="font-size:14px; margin-bottom: 20px;">AVAILABLE TASKS</h1>
            <ul id="taskList" class="list"></ul>
        </div>
    </div>
    
    <!-- Withdraw View -->
    <div id="withdrawView" class="app-view">
        <div class="app-container">
            <a class="back-button" onclick="showView('dashboardView')">&lt; BACK</a>
            <h1 style="font-size:14px; margin-bottom: 20px;">WITHDRAW FUNDS</h1>
            <div class="pixel-card">
                <div class="form-group"> <label for="amount">AMOUNT (MIN: P500)</label> <input type="number" id="amount" placeholder="500"> </div>
                <div class="form-group"> <label>METHOD</label> <div class="method-selector"> <button id="gcashBtn">GCASH</button> <button id="mayaBtn">MAYA</button> </div> </div>
                <div class="form-group"> <label for="details">ACCOUNT NUMBER</label> <input type="tel" id="details" placeholder="09XX XXX XXXX"> </div>
                <a id="submitWithdrawalBtn" class="pixel-button" style="background-color: var(--accent-green); color: var(--pixel-border);">SUBMIT</a>
            </div>
        </div>
    </div>

    <!-- Referral Modal -->
    <div id="referralModal" class="modal-overlay">
        <div class="modal-content">
            <a id="closeModal" style="position:absolute; top: 10px; right: 20px; font-size: 18px; cursor: pointer;">X</a>
            <h2>INVITE & EARN</h2>
            <p>SHARE YOUR LINK AND GET P10 FOR EVERY FRIEND THAT JOINS!</p>
            <div id="referralLink" class="referral-link-box">...</div>
            <div class="action-grid">
                <a id="copyBtn" class="pixel-button">COPY</a>
                <a id="shareBtn" class="pixel-button">SHARE</a>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- IMPORTANT: Set your backend URL from Railway here ---
        const API_BASE_URL = "https://64628638262626-production.up.railway.app";
        const BOT_USERNAME = "GTaskPHBot";
        const user = tg.initDataUnsafe.user;
        const initData = tg.initData;

        let userBalance = 0; let withdrawalMethod = '';
        let userData = {};

        const views = document.querySelectorAll('.app-view');
        function showView(viewId) { tg.HapticFeedback.impactOccurred('light'); views.forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast'; toast.innerText = message;
            document.body.appendChild(toast);
            toast.style.animation = 'toastIn 0.3s ease-out forwards';
            setTimeout(() => { toast.style.animation = 'toastOut 0.3s ease-out forwards'; setTimeout(() => toast.remove(), 300); }, 2500);
        }

        async function fetchInitialData() {
            document.getElementById('loadingView').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/get_initial_data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData }) });
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                
                userData = data;
                userBalance = data.balance;
                document.getElementById('balanceAmount').innerText = `P${userBalance.toFixed(2)}`;
                
                const taskList = document.getElementById('taskList'); taskList.innerHTML = '';
                if (data.tasks.length > 0) data.tasks.forEach(task => { const li = document.createElement('li'); li.className = 'list-item'; li.innerHTML = `<h3>${task.description}</h3><p>REWARD: P${task.reward.toFixed(2)}</p><a href="${task.link}" target="_blank">GO TO LINK &gt;</a>`; taskList.appendChild(li); }); else taskList.innerHTML = '<li class="list-item"><p>NO TASKS AVAILABLE.</p></li>';
                
                document.getElementById('profileName').innerText = `NAME: ${user.first_name || 'PLAYER'}`;
                document.getElementById('profileId').innerText = `USER ID: ${user.id}`;
                // We will need to add referral count to the backend response to show it here. For now, it's a placeholder.

            } catch (error) { tg.showAlert(error.message || 'COULD NOT LOAD DATA. PLEASE RESTART.'); } finally { document.getElementById('loadingView').style.display = 'none'; }
        }
        
        window.addEventListener('load', fetchInitialData);
        if (user && user.first_name) document.getElementById('welcome-message').innerText = `HEY, ${user.first_name}!`;
        
        // --- Event Listeners ---
        document.getElementById('tasksBtn').addEventListener('click', () => showView('tasksView'));
        document.getElementById('withdrawBtn').addEventListener('click', () => showView('withdrawView'));
        document.getElementById('profileBtn').addEventListener('click', () => showView('profileView'));
        document.getElementById('inviteBtn').addEventListener('click', () => { tg.HapticFeedback.impactOccurred('medium'); document.getElementById('referralLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`; document.getElementById('referralModal').style.display = 'flex'; });
        document.getElementById('closeModal').addEventListener('click', () => { document.getElementById('referralModal').style.display = 'none'; });
        document.getElementById('copyBtn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('referralLink').innerText).then(() => { tg.HapticFeedback.notificationOccurred('success'); showToast('LINK COPIED!'); }); });
        document.getElementById('shareBtn').addEventListener('click', () => { const link = document.getElementById('referralLink').innerText; tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=JOIN AND EARN!`); });
        document.getElementById('gcashBtn').addEventListener('click', () => { withdrawalMethod = 'GCash'; document.getElementById('gcashBtn').classList.add('selected'); document.getElementById('mayaBtn').classList.remove('selected'); });
        document.getElementById('mayaBtn').addEventListener('click', () => { withdrawalMethod = 'Maya'; document.getElementById('mayaBtn').classList.add('selected'); document.getElementById('gcashBtn').classList.remove('selected'); });
        
        document.getElementById('submitWithdrawalBtn').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('amount').value); const details = document.getElementById('details').value;
            if (isNaN(amount) || amount < 500) { tg.showAlert('AMOUNT MUST BE AT LEAST P500.'); return; }
            if (amount > userBalance) { tg.showAlert('INSUFFICIENT BALANCE.'); return; }
            if (!withdrawalMethod) { tg.showAlert('SELECT A METHOD.'); return; }
            if (!details) { tg.showAlert('ENTER ACCOUNT NUMBER.'); return; }

            document.getElementById('loadingView').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/submit_withdrawal`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, amount, method: withdrawalMethod, details }) });
                const result = await response.json();
                if (result.status === 'success') { tg.showAlert('REQUEST SUBMITTED!'); tg.close(); } else { tg.showAlert(result.message || 'ERROR.'); }
            } catch (error) { tg.showAlert('COULD NOT SUBMIT. PLEASE TRY AGAIN.'); } finally { document.getElementById('loadingView').style.display = 'none'; }
        });
    </script>
</body>
</html>
