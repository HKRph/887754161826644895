<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GTaskPH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #212121);
            --tg-text: var(--tg-theme-text-color, #eeeeee);
            --tg-hint: var(--tg-theme-hint-color, #9e9e9e);
            --tg-button: var(--tg-theme-button-color, #42a5f5);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #303030);
            --pixel-border-light: #424242;
            --pixel-border-dark: #000000;
            --accent-green: #00e676; --accent-red: #ff5252; --accent-yellow: #ffea00;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toastIn { from { opacity: 0; bottom: 60px; } to { opacity: 1; bottom: 80px; } }
        @keyframes toastOut { to { opacity: 0; bottom: 60px; } }
        body { font-family: 'VT323', monospace; padding: 10px 10px 80px 10px; margin: 0; color: var(--tg-text); background-color: var(--tg-bg); -webkit-font-smoothing: none; image-rendering: pixelated; animation: fadeIn 0.5s; }
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s; }
        .pixel-container { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 15px; margin-bottom: 15px; }
        .header h1 { font-size: 28px; margin: 0 0 10px 0; } .header p { font-size: 18px; color: var(--tg-hint); margin: 0; }
        .balance-card h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--tg-hint); } .balance-card .balance-amount { font-size: 42px; color: var(--accent-yellow); }
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; margin-bottom: 15px; }
        .list-item h3 { margin: 0 0 8px 0; font-size: 20px; } .list-item p { margin: 0 0 12px 0; font-size: 16px; color: var(--tg-hint); }
        .button { padding: 12px; border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-button); color: var(--tg-button-text); font-size: 18px; font-family: 'VT323', monospace; cursor: pointer; text-align: center; } .button:active { border-color: var(--pixel-border-light); border-right-color: var(--pixel-border-dark); border-bottom-color: var(--pixel-border-dark); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .stat-card { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; text-align: center; } .stat-card .value { font-size: 28px; } .stat-card .label { font-size: 16px; color: var(--tg-hint); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--tg-secondary-bg); border-top: 3px solid var(--pixel-border-light); padding: 5px 0; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: var(--tg-hint); cursor: pointer; padding: 5px 0; }
        .nav-item .icon { font-size: 24px; } .nav-item .label { font-size: 12px; }
        .nav-item.active { filter: drop-shadow(0 0 3px var(--tg-button)); color: var(--tg-text); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; font-size: 24px; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 20px; width: 90%; max-width: 400px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; font-size: 18px; margin-bottom: 8px; } .form-group input, .form-group textarea { width: 100%; padding: 10px; font-size: 18px; font-family: 'VT323', monospace; border: 3px solid var(--pixel-border-dark); background-color: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--tg-secondary-bg); color: var(--tg-text); padding: 15px; z-index: 2000; border: 3px solid var(--pixel-border-light); font-size: 18px; animation: toastIn 0.3s, toastOut 0.3s 2.2s; }
        .withdrawal-item .status { float: right; font-weight: 600; font-size: 16px; } .status-pending { color: var(--accent-yellow); } .status-approved { color: var(--accent-green); } .status-rejected { color: var(--accent-red); }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay" style="display: flex;">Loading...</div>

    <!-- Home View -->
    <div id="homeView" class="app-view active">
        <div class="header"> <h1 id="welcome-message">GTaskPH</h1> <p>Your Pixel Quest for Rewards!</p> </div>
        <div class="pixel-container balance-card"> <h2>Balance</h2> <p id="balanceAmount" class="balance-amount">P--.--</p> </div>
        <div class="pixel-container announcement-card"> <h3>Announcements</h3> <p id="announcementText">Loading latest news...</p> </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="app-view">
        <div class="header"> <h1>Task Board</h1> </div>
        <ul id="taskList" class="list"></ul>
    </div>

    <!-- Referrals View -->
    <div id="referralView" class="app-view">
        <div class="header"> <h1>Invite Allies</h1> </div>
        <div class="stats-grid">
            <div class="stat-card"> <div id="referralCount" class="value">0</div> <div class="label">Allies Recruited</div> </div>
            <div class="stat-card"> <div id="successfulReferralCount" class="value">0</div> <div class="label">Successful Quests</div> </div>
        </div>
        <br>
        <div class="pixel-container">
            <h3>Your Unique Scroll</h3>
            <p style="font-size: 16px; line-height: 1.5;">Share this scroll. For every ally who joins and completes their first quest, you earn <strong>P77.00</strong>!</p>
            <div id="referralLink" style="background: var(--tg-bg); padding: 10px; word-wrap: break-word; font-size: 14px; margin: 15px 0; border: 2px inset var(--pixel-border-dark);"></div>
            <a id="copyLinkBtn" class="button">Copy Scroll</a>
        </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="app-view">
        <div class="header"> <h1>Player Info</h1> </div>
        <div class="pixel-container">
            <p id="profileName" style="font-size: 18px;">Player: ...</p>
            <p id="profileId" style="font-size: 14px; color: var(--tg-hint);">ID: ...</p>
        </div>
        <div class="pixel-container">
            <h3>Redeem Scroll</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input id="redeemCodeInput" type="text" placeholder="Enter Code" style="flex-grow: 1; margin: 0;">
                <a id="redeemCodeBtn" class="button" style="padding: 10px 15px;">OK</a>
            </div>
        </div>
        <div class="pixel-container">
            <h3>Withdrawal History</h3>
            <ul id="withdrawalList" class="list" style="max-height: 150px; overflow-y: auto;"></ul>
        </div>
    </div>

    <!-- Task Submission Modal -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="taskModalTitle" style="font-size: 20px;">Submit Proof</h2>
            <form id="taskProofForm">
                <div class="form-group"><label for="taskProofText">Note (Optional)</label><textarea id="taskProofText" rows="2"></textarea></div>
                <div class="form-group"><label for="taskProofPhoto">Upload Image Proof</label><input type="file" id="taskProofPhoto" accept="image/*" required></div>
                <div style="display: flex; gap: 10px;"><a id="cancelSubmitBtn" class="button" style="background: var(--tg-hint); flex:1;">Cancel</a><button type="submit" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark); flex:1;">Submit</button></div>
            </form>
        </div>
    </div>

    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showView('homeView')"> <div class="icon">üè†</div> <div class="label">Home</div> </div>
        <div id="navTasks" class="nav-item" onclick="showView('tasksView')"> <div class="icon">üìú</div> <div class="label">Tasks</div> </div>
        <div id="navReferral" class="nav-item" onclick="showView('referralView')"> <div class="icon">ü§ù</div> <div class="label">Refer</div> </div>
        <div id="navProfile" class="nav-item" onclick="showView('profileView')"> <div class="icon">üë§</div> <div class="label">Profile</div> </div>
    </nav>
    
    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        
        // YOUR URL IS NOW HERE
        const API_BASE_URL = "https://64628638262626-production.up.railway.app"; 

        const BOT_USERNAME = "GTaskPHBot"; const user = tg.initDataUnsafe.user; const initData = tg.initData; let appData = {};
        const views = document.querySelectorAll('.app-view'); const navItems = document.querySelectorAll('.nav-item');
        function showView(viewId) { tg.HapticFeedback.impactOccurred('light'); views.forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); navItems.forEach(n => n.classList.remove('active')); try { document.getElementById(`nav${viewId.replace('View', '')}`).classList.add('active'); } catch (e) {} }
        function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = message; document.body.appendChild(toast); setTimeout(() => { toast.remove(); }, 2500); }
        async function fetchInitialData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/get_initial_data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData }) });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`Network response was not ok: ${errorText}`); }
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                appData = data;
                renderAll();
            } catch (error) { tg.showAlert(error.message || 'COULD NOT LOAD DATA. PLEASE RESTART.'); } finally { document.getElementById('loading').style.display = 'none'; }
        }
        function renderAll(){
            document.getElementById('balanceAmount').innerText = `P${(appData.balance || 0).toFixed(2)}`;
            document.getElementById('announcementText').innerText = appData.announcement || "Welcome! No new announcements at this time.";
            const taskList = document.getElementById('taskList'); taskList.innerHTML = '';
            if (appData.tasks && appData.tasks.length > 0) { appData.tasks.forEach(task => { const li = document.createElement('li'); li.className = 'list-item'; li.innerHTML = `<h3>${task.description}</h3><p>REWARD: P${task.reward.toFixed(2)}</p><div style="display:flex; gap: 10px; margin-top: 15px;"><a href="${task.link}" target="_blank" class="button" style="flex:1;">Visit Link</a><a class="button submit-proof-btn" data-task-id="${task.id}" style="flex:1; background: var(--accent-green); color: var(--pixel-border-dark);">Submit Proof</a></div>`; taskList.appendChild(li); }); } else { taskList.innerHTML = '<li class="list-item"><p>No tasks available right now. Check back later!</p></li>'; }
            document.getElementById('referralCount').innerText = appData.referral_count || 0;
            document.getElementById('successfulReferralCount').innerText = appData.successful_referrals || 0;
            document.getElementById('referralLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            document.getElementById('profileName').innerText = `Player: ${user.first_name || 'Unknown'}`;
            document.getElementById('profileId').innerText = `ID: ${user.id}`;
            const withdrawalList = document.getElementById('withdrawalList'); withdrawalList.innerHTML = '';
            if (appData.withdrawals && appData.withdrawals.length > 0) appData.withdrawals.forEach(w => { const item = document.createElement('li'); item.className = 'list-item'; item.innerHTML = `<span>P${w.amount.toFixed(2)} (${w.method})</span><span class="status status-${w.status}">${w.status}</span>`; withdrawalList.appendChild(item); }); else withdrawalList.innerHTML = '<li class="list-item"><p>No withdrawal history.</p></li>';
        }
        window.addEventListener('load', fetchInitialData);
        if (user && user.first_name) document.getElementById('welcome-message').innerText = `Hey, ${user.first_name}!`;
        document.getElementById('copyLinkBtn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('referralLink').innerText).then(() => { tg.HapticFeedback.notificationOccurred('success'); showToast('Link Copied!'); }); });
        document.getElementById('taskList').addEventListener('click', e => { if (e.target.classList.contains('submit-proof-btn')) { openTaskModal(e.target.getAttribute('data-task-id')); }});
        const taskModal = document.getElementById('taskModal'); let currentTaskId = null;
        function openTaskModal(taskId) { currentTaskId = taskId; taskModal.style.display = 'flex'; }
        document.getElementById('cancelSubmitBtn').addEventListener('click', () => { taskModal.style.display = 'none'; });
        taskModal.addEventListener('click', (e) => { if (e.target === taskModal) taskModal.style.display = 'none'; });
        document.getElementById('taskProofForm').addEventListener('submit', async function(e) {
            e.preventDefault(); const text = document.getElementById('taskProofText').value; const photoInput = document.getElementById('taskProofPhoto'); if (photoInput.files.length === 0) { tg.showAlert('Please upload a screenshot.'); return; }
            const reader = new FileReader(); reader.readAsDataURL(photoInput.files[0]);
            reader.onload = async () => {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const response = await fetch(`${API_BASE_URL}/submit_task_proof`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, task_id: currentTaskId, text, photo: reader.result }) });
                    const result = await response.json();
                    if (result.status === 'success') { tg.showAlert('Proof submitted for review!'); taskModal.style.display = 'none'; } else { throw new Error(result.message); }
                } catch (error) { tg.showAlert(error.message || 'Submission failed.'); } finally { document.getElementById('loading').style.display = 'none'; }
            };
            reader.onerror = () => { tg.showAlert('Error reading file.'); };
        });
        document.getElementById('redeemCodeBtn').addEventListener('click', async () => {
            const code = document.getElementById('redeemCodeInput').value; if (!code) { return; }
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/redeem_code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, code }) });
                const result = await response.json();
                if (result.status === 'success') { tg.showAlert(`Success! P${result.amount_rewarded.toFixed(2)} added to your balance.`); fetchInitialData(); } else { throw new Error(result.message); }
            } catch (error) { tg.showAlert(error.message || 'Invalid code.'); } finally { document.getElementById('loading').style.display = 'none'; }
        });
    </script>
</body>
</html>