<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GTaskPH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #212121);
            --tg-text: var(--tg-theme-text-color, #eeeeee);
            --tg-hint: var(--tg-theme-hint-color, #9e9e9e);
            --tg-button: var(--tg-theme-button-color, #42a5f5);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #303030);
            --pixel-border-light: #424242;
            --pixel-border-dark: #000000;
            --accent-green: #00e676; --accent-red: #ff5252; --accent-yellow: #ffea00;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toastIn { from { opacity: 0; bottom: 60px; } to { opacity: 1; bottom: 80px; } }
        @keyframes toastOut { to { opacity: 0; bottom: 60px; } }
        body { font-family: 'VT323', monospace; padding: 10px 10px 80px 10px; margin: 0; color: var(--tg-text); background-color: var(--tg-bg); -webkit-font-smoothing: none; image-rendering: pixelated; animation: fadeIn 0.5s; }
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s; }
        .pixel-container { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 15px; margin-bottom: 15px; }
        .header h1 { font-size: 28px; margin: 0 0 10px 0; } .header p { font-size: 18px; color: var(--tg-hint); margin: 0; }
        .balance-card h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--tg-hint); } .balance-card .balance-amount { font-size: 42px; color: var(--accent-yellow); }
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; margin-bottom: 15px; }
        .list-item h3 { margin: 0 0 8px 0; font-size: 20px; } .list-item p { margin: 0 0 12px 0; font-size: 16px; color: var(--tg-hint); }
        .button { padding: 12px; border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-button); color: var(--tg-button-text); font-size: 18px; font-family: 'VT323', monospace; cursor: pointer; text-align: center; } .button:active { border-color: var(--pixel-border-light); border-right-color: var(--pixel-border-dark); border-bottom-color: var(--pixel-border-dark); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .stat-card { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; text-align: center; } .stat-card .value { font-size: 28px; } .stat-card .label { font-size: 16px; color: var(--tg-hint); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--tg-secondary-bg); border-top: 3px solid var(--pixel-border-light); padding: 5px 0; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: var(--tg-hint); cursor: pointer; padding: 5px 0; }
        .nav-item .icon { font-size: 24px; } .nav-item .label { font-size: 12px; }
        .nav-item.active { filter: drop-shadow(0 0 3px var(--tg-button)); color: var(--tg-text); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; font-size: 24px; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 20px; width: 90%; max-width: 400px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; font-size: 18px; margin-bottom: 8px; } .form-group input, .form-group textarea { width: 100%; padding: 10px; font-size: 18px; font-family: 'VT323', monospace; border: 3px solid var(--pixel-border-dark); background-color: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--tg-secondary-bg); color: var(--tg-text); padding: 15px; z-index: 2000; border: 3px solid var(--pixel-border-light); font-size: 18px; animation: toastIn 0.3s, toastOut 0.3s 2.2s; }
        .withdrawal-item .status { float: right; font-weight: 600; font-size: 16px; } .status-pending { color: var(--accent-yellow); } .status-approved { color: var(--accent-green); } .status-rejected { color: var(--accent-red); }
        .daily-bonus-card .button.disabled { background-color: var(--tg-hint); cursor: not-allowed; opacity: 0.7; }
        .daily-bonus-card .progress-bar { height: 10px; background-color: var(--tg-bg); border: 2px solid var(--pixel-border-dark); margin-top: 10px; }
        .daily-bonus-card .progress-fill { height: 100%; width: 0%; background-color: var(--accent-green); transition: width 0.5s ease-in-out; }
        .task-milestone-card .milestone-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 16px; }
        .task-milestone-card .milestone-item .reward { color: var(--accent-yellow); }
        .task-milestone-card .milestone-item .claimed { color: var(--accent-green); }
        .method-selector { display: flex; gap: 10px; } .method-selector button { flex-grow: 1; padding: 12px; border: 3px solid var(--pixel-border-dark); background-color: var(--tg-bg); color: var(--tg-text); font-size: 18px; font-family: 'VT323', monospace; cursor: pointer; } .method-selector button.selected { background-color: var(--tg-text); color: var(--tg-bg); }
        .withdrawal-maintenance-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; color: white; text-align: center; font-size: 20px; }
        /* Game specific styles */
        .game-room-item { display: flex; justify-content: space-between; align-items: center; }
        .game-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .game-choice-button { flex: 1; padding: 20px; font-size: 40px; background: var(--tg-bg); border: 3px solid var(--pixel-border-dark); }
        .game-choice-button.selected { border-color: var(--tg-button); }
        .game-choice-button.disabled { cursor: not-allowed; opacity: 0.6; }
        .game-result { text-align: center; margin-top: 20px; font-size: 24px; }
        .game-move { font-size: 36px; margin: 10px; }
        .game-moves-display { display: flex; justify-content: space-around; margin-top: 20px; font-size: 24px; }
        .game-status-box { text-align: center; margin-bottom: 20px; font-size: 18px; color: var(--accent-yellow); }
        .game-result-box { text-align: center; margin-top: 20px; font-size: 24px; font-weight: bold; color: var(--tg-text); }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay" style="display: flex;">
        <span style="display:inline-block; animation: blink 1s infinite;">LOADING...</span>
        <style>@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }</style>
    </div>

    <!-- Home View -->
    <div id="homeView" class="app-view active">
        <div class="header"> <h1 id="welcome-message">GTaskPH</h1> <p>Your Pixel Quest for Rewards!</p> </div>
        <div class="pixel-container balance-card"> <h2>Balance</h2> <p id="balanceAmount" class="balance-amount">P--.--</p> </div>
        
        <div class="pixel-container daily-bonus-card">
            <h3>Daily Login Bonus</h3>
            <p id="dailyBonusStatus" style="font-size: 16px; margin-bottom: 10px; color: var(--tg-hint);">Loading...</p>
            <div class="progress-bar"><div id="dailyBonusProgress" class="progress-fill"></div></div>
            <a id="claimDailyBonusBtn" class="button" style="margin-top: 15px;">Claim Bonus (P10.00)</a>
        </div>

        <div class="pixel-container announcement-card"> <h3>Announcements</h3> <p id="announcementText">Loading latest news...</p> </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="app-view">
        <div class="header"> <h1>Task Board</h1> </div>
        <ul id="taskList" class="list"></ul>
    </div>

    <!-- Referrals View -->
    <div id="referralView" class="app-view">
        <div class="header"> <h1>Invite Allies</h1> </div>
        <div class="stats-grid">
            <div class="stat-card"> <div id="referralCount" class="value">0</div> <div class="label">Allies Recruited</div> </div>
            <div class="stat-card"> <div id="successfulReferralCount" class="value">0</div> <div class="label">Successful Quests</div> </div>
        </div>
        <br>
        <div class="pixel-container">
            <h3>Your Unique Scroll</h3>
            <p style="font-size: 16px; line-height: 1.5;">Share this scroll. For every ally who joins and completes their first quest, you earn <strong>P77.00</strong>!</p>
            <div id="referralLink" style="background: var(--tg-bg); padding: 10px; word-wrap: break-word; font-size: 14px; margin: 15px 0; border: 2px inset var(--pixel-border-dark);"></div>
            <a id="copyLinkBtn" class="button">Copy Scroll</a>
        </div>
    </div>
    
    <!-- Gift View -->
    <div id="giftView" class="app-view">
        <div class="header"> <h1>Gift Treasury</h1> </div>
        <div class="pixel-container">
            <h3>Your Gift Tickets</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <span id="giftTicketCount" style="font-size: 42px; color: var(--accent-yellow);">0</span>
                <p style="color: var(--tg-hint); font-size: 16px; margin-top: 5px;">Tickets Available</p>
            </div>
            <a id="buyTicketBtn" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark);">Buy Tickets (P77.00 - B1G1)</a>
        </div>
        <div class="pixel-container">
            <h3>Send a Gift</h3>
            <p style="font-size: 16px; line-height: 1.5;">Uses 1 Ticket. A 5% fee applies to the sent amount from your balance.</p>
            <form id="giftForm">
                <div class="form-group"><label for="giftRecipientId">Recipient User ID</label><input type="number" id="giftRecipientId" placeholder="e.g., 123456789"></div>
                <div class="form-group"><label for="giftAmount">Amount (Min: P300)</label><input type="number" id="giftAmount" placeholder="e.g., 500"></div>
                <button type="submit" class="button">Send Gift</button>
            </form>
        </div>
    </div>

    <!-- Games View (Jack and Poy) -->
    <div id="gamesView" class="app-view">
        <div class="header"> <h1>Arcade</h1> <p>Play Jack & Poy!</p> </div>
        <div class="pixel-container">
            <h3>Create New Room</h3>
            <p style="font-size: 16px; line-height: 1.5;">Bet your coins against other players. Winner takes all (minus 10% fee).</p>
            <form id="createGameRoomForm">
                <div class="form-group"><label for="createBetAmount">Bet Amount (Min: P10)</label><input type="number" id="createBetAmount" placeholder="e.g., 50"></div>
                <button type="submit" class="button" style="background: var(--accent-yellow); color: var(--pixel-border-dark);">Create Room</button>
            </form>
        </div>
        <div class="pixel-container">
            <h3>Open Rooms</h3>
            <ul id="gameRoomsList" class="list"></ul>
        </div>
    </div>

    <!-- Game Play Modal -->
    <div id="gamePlayModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="gamePlayModalTitle" style="font-size: 20px;">Jack & Poy!</h2>
            <p id="gameStatusText" class="game-status-box">Connecting to game...</p>
            <div id="gameMoves" class="game-moves-display">
                <div style="text-align: center;"><p style="font-size: 14px; margin: 0;">YOU</p><div id="playerMoveDisplay" class="game-move">?</div></div>
                <div style="text-align: center;"><p style="font-size: 14px; margin: 0;">OPPONENT</p><div id="opponentMoveDisplay" class="game-move">?</div></div>
            </div>
            <div id="gameChoices" class="game-buttons">
                <button class="game-choice-button" data-move="rock">✊</button>
                <button class="game-choice-button" data-move="paper">✋</button>
                <button class="game-choice-button" data-move="scissors">✌️</button>
            </div>
            <a id="cancelGameBtn" class="button" style="background: var(--accent-red); margin-top: 15px;">Leave Game</a>
        </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="app-view">
        <div class="header"> <h1>Player Info</h1> </div>
        <div class="pixel-container">
            <p id="profileName" style="font-size: 18px;">Player: ...</p>
            <p id="profileId" style="font-size: 14px; color: var(--tg-hint);">ID: ...</p>
            <p id="tasksCompleted" style="font-size: 14px; color: var(--tg-hint);">Tasks Completed: 0</p>
        </div>
        <div class="pixel-container task-milestone-card">
            <h3>Task Milestones</h3>
            <div id="taskMilestonesList"></div>
        </div>
        <div class="pixel-container">
            <h3>Redeem Scroll</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input id="redeemCodeInput" type="text" placeholder="Enter Code" style="flex-grow: 1; margin: 0;">
                <a id="redeemCodeBtn" class="button" style="padding: 10px 15px;">OK</a>
            </div>
        </div>
        <div class="pixel-container" style="position: relative;">
            <div id="withdrawalMaintenanceOverlay" class="withdrawal-maintenance-overlay" style="display:none;">WITHDRAWAL<br>MAINTENANCE</div>
            <h3>Withdraw Funds</h3>
            <p style="font-size: 16px; line-height: 1.5;"><span id="minWithdrawalText">Min: P300.00</span>, <span id="maxWithdrawalText">Max: P30000.00</span></p>
            <form id="withdrawForm">
                <div class="form-group"><label for="withdrawAmount">Amount</label><input type="number" id="withdrawAmount" placeholder="e.g., 500"></div>
                <div class="form-group"><label>Method</label><div class="method-selector"><button type="button" id="gcashBtn">GCASH</button><button type="button" id="mayaBtn">MAYA</button></div></div>
                <div class="form-group"><label for="withdrawDetails">Account Number</label><input type="tel" id="withdrawDetails" placeholder="Your GCash/Maya number"></div>
                <p id="withdrawalFeeText" style="font-size: 14px; color: var(--tg-hint); text-align: center; display: none;"></p>
                <button type="submit" class="button" style="background: var(--accent-red); color: var(--tg-button-text); margin-top: 10px;">Submit Withdrawal</button>
            </form>
        </div>
        <div class="pixel-container">
            <h3>Withdrawal History</h3>
            <ul id="withdrawalList" class="list" style="max-height: 150px; overflow-y: auto;"></ul>
        </div>
    </div>

    <!-- Task Submission Modal -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="taskModalTitle" style="font-size: 20px;">Submit Proof</h2>
            <form id="taskProofForm">
                <div class="form-group"><label for="taskProofText">Note (Optional)</label><textarea id="taskProofText" rows="2"></textarea></div>
                <div class="form-group"><label for="taskProofPhoto">Upload Image Proof</label><input type="file" id="taskProofPhoto" accept="image/*" required></div>
                <div style="display: flex; gap: 10px;"><a id="cancelSubmitBtn" class="button" style="background: var(--tg-hint); flex:1;">Cancel</a><button type="submit" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark); flex:1;">Submit</button></div>
            </form>
        </div>
    </div>

    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showView('homeView')"> <div class="icon">🏠</div> <div class="label">Home</div> </div>
        <div id="navTasks" class="nav-item" onclick="showView('tasksView')"> <div class="icon">📜</div> <div class="label">Tasks</div> </div>
        <div id="navReferral" class="nav-item" onclick="showView('referralView')"> <div class="icon">🤝</div> <div class="label">Refer</div> </div>
        <div id="navGift" class="nav-item" onclick="showView('giftView')"> <div class="icon">🎁</div> <div class="label">Gift</div> </div>
        <div id="navGames" class="nav-item" onclick="showView('gamesView')"> <div class="icon">🎮</div> <div class="label">Games</div> </div>
        <div id="navProfile" class="nav-item" onclick="showView('profileView')"> <div class="icon">👤</div> <div class="label">Profile</div> </div>
    </nav>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- IMPORTANT: Replace this with your actual backend URL ---
        const API_BASE_URL = "https://64628638262626-production.up.railway.app"; // Example: Your Render/Railway URL
        const BOT_USERNAME = "GTaskPHBot"; // Replace with your Bot Username
        
        const user = tg.initDataUnsafe.user;
        const initData = tg.initData;

        let appData = {}; 
        let currentTaskId = null;
        let withdrawalMethod = '';
        let gameWs = null;
        let currentGameRoomId = null;
        let playerMove = null;

        // --- Dynamic Constants (will be fetched from backend) ---
        let MIN_WITHDRAWAL_JS = 300; 
        let MAX_WITHDRAWAL_JS = 30000;
        let WITHDRAWAL_FEE_PERCENT_JS = 0.03;
        let DAILY_BONUS_INVITE_REQ_JS = 2;
        let DAILY_BONUS_AMOUNT_JS = 10;
        let GIFT_TICKET_PRICE_JS = 77;
        let GIFT_MIN_AMOUNT_JS = 300;
        let GIFT_FEE_PERCENT_JS = 0.05;
        let MIN_GAME_BET_JS = 10;
        const TASK_MILESTONES_UI = {10: 50.0, 20: 150.0, 30: 400.0};

        // --- UI Navigation ---
        const views = document.querySelectorAll('.app-view');
        const navItems = document.querySelectorAll('.nav-item');
        function showView(viewId) { 
            tg.HapticFeedback.impactOccurred('light'); 
            views.forEach(v => v.classList.remove('active')); 
            document.getElementById(viewId).classList.add('active'); 
            navItems.forEach(n => n.classList.remove('active')); 
            const navId = `nav${viewId.replace('View', '')}`;
            document.getElementById(navId).classList.add('active'); 
            
            // Refresh data when switching to views that need it
            if (['tasksView', 'gamesView', 'profileView'].includes(viewId)) {
                fetchInitialData();
            }
        }

        function showToast(message) { 
            const toast = document.createElement('div'); 
            toast.className = 'toast';
            toast.innerText = message; 
            document.body.appendChild(toast); 
            setTimeout(() => { toast.remove(); }, 2500); 
        }

        // --- API Interaction ---
        async function apiCall(endpoint, body) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ...body, user_id: user.id, _auth: initData })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                tg.showAlert(error.message);
                console.error(`API call to ${endpoint} failed:`, error);
                throw error; // Re-throw to be caught by the caller
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function fetchInitialData() {
            try {
                const data = await apiCall('/get_initial_data', {});
                appData = data;
                
                // Update dynamic constants from backend
                MIN_WITHDRAWAL_JS = data.min_withdrawal;
                MAX_WITHDRAWAL_JS = data.max_withdrawal;
                WITHDRAWAL_FEE_PERCENT_JS = data.withdrawal_fee_percent;
                DAILY_BONUS_INVITE_REQ_JS = data.daily_bonus_req;
                DAILY_BONUS_AMOUNT_JS = data.daily_bonus_amount; 
                GIFT_TICKET_PRICE_JS = data.gift_ticket_price;
                GIFT_MIN_AMOUNT_JS = data.gift_min_amount;
                GIFT_FEE_PERCENT_JS = data.gift_fee_percent;
                MIN_GAME_BET_JS = data.min_game_bet;
                
                renderAll();
            } catch (error) {
                // Error is already shown by apiCall, no need for another alert
            }
        }

        // --- UI Rendering ---
        function renderAll() {
            // Home View
            document.getElementById('balanceAmount').innerText = `P${(appData.balance || 0).toFixed(2)}`;
            document.getElementById('announcementText').innerText = appData.announcement || "No new announcements.";

            // Daily Bonus
            const claimBtn = document.getElementById('claimDailyBonusBtn');
            const dailyBonusStatus = document.getElementById('dailyBonusStatus');
            const dailyBonusProgress = document.getElementById('dailyBonusProgress');
            if (appData.can_claim_daily) {
                claimBtn.classList.remove('disabled');
                claimBtn.innerText = `Claim Bonus (P${DAILY_BONUS_AMOUNT_JS.toFixed(2)})`;
                dailyBonusStatus.innerText = 'Ready to Claim!';
                dailyBonusProgress.style.width = '100%';
            } else {
                claimBtn.classList.add('disabled');
                const invitesNeeded = Math.max(0, DAILY_BONUS_INVITE_REQ_JS - appData.daily_claim_invites);
                const buttonText = invitesNeeded > 0 ? `Invite ${invitesNeeded} more to claim!` : 'Claimed for today!';
                claimBtn.innerText = buttonText;
                dailyBonusStatus.innerText = `Today's Invites: ${appData.daily_claim_invites}/${DAILY_BONUS_INVITE_REQ_JS}`;
                dailyBonusProgress.style.width = `${Math.min(100, (appData.daily_claim_invites / DAILY_BONUS_INVITE_REQ_JS) * 100)}%`;
            }

            // Tasks View
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            if (appData.tasks && appData.tasks.length > 0) {
                appData.tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<h3>${task.description}</h3><p>REWARD: P${task.reward.toFixed(2)}</p>
                                    <div style="display:flex; gap: 10px; margin-top: 15px;">
                                        <a href="${task.link}" target="_blank" class="button" style="flex:1;">Visit Link</a>
                                        <a class="button submit-proof-btn" data-task-id="${task.id}" style="flex:1; background: var(--accent-green); color: var(--pixel-border-dark);">Submit Proof</a>
                                    </div>`;
                    taskList.appendChild(li);
                });
            } else {
                taskList.innerHTML = '<li class="list-item"><p>No tasks available right now. Check back later!</p></li>';
            }

            // Referrals View
            document.getElementById('referralCount').innerText = appData.referral_count || 0;
            document.getElementById('successfulReferralCount').innerText = appData.successful_referrals || 0;
            document.getElementById('referralLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            
            // Gift View
            document.getElementById('giftTicketCount').innerText = appData.gift_tickets || 0;
            document.querySelector('#buyTicketBtn').innerText = `Buy Tickets (P${GIFT_TICKET_PRICE_JS.toFixed(2)} - B1G1)`;
            document.querySelector('#giftAmount').placeholder = `Min: P${GIFT_MIN_AMOUNT_JS.toFixed(2)}`;

            // Games View
            renderGameRooms();

            // Profile View
            document.getElementById('profileName').innerText = `Player: ${user.first_name || 'Unknown'}`;
            document.getElementById('profileId').innerText = `ID: ${user.id}`;
            document.getElementById('tasksCompleted').innerText = `Tasks Completed: ${appData.tasks_completed || 0}`;

            // Task Milestones
            const milestonesList = document.getElementById('taskMilestonesList');
            milestonesList.innerHTML = '';
            for (const count in TASK_MILESTONES_UI) {
                const reward = TASK_MILESTONES_UI[count];
                const isClaimed = appData.claimed_milestones[`${count}_tasks`];
                const canClaim = appData.tasks_completed >= count;
                const status = isClaimed ? 'CLAIMED' : (canClaim ? 'READY' : 'PENDING');
                const color = isClaimed ? 'var(--accent-green)' : (canClaim ? 'var(--accent-yellow)' : 'var(--tg-hint)');
                milestonesList.innerHTML += `<div class="milestone-item"><span>${count} Tasks:</span><span style="color: ${color};">P${reward.toFixed(2)} (${status})</span></div>`;
            }

            // Withdrawal Section
            document.getElementById('minWithdrawalText').innerText = `Min: P${MIN_WITHDRAWAL_JS.toFixed(2)}`;
            document.getElementById('maxWithdrawalText').innerText = `Max: P${MAX_WITHDRAWAL_JS.toFixed(2)}`;
            const withdrawalOverlay = document.getElementById('withdrawalMaintenanceOverlay');
            withdrawalOverlay.style.display = appData.withdrawal_maintenance ? 'flex' : 'none';

            // Withdrawal History
            const withdrawalList = document.getElementById('withdrawalList');
            withdrawalList.innerHTML = '';
            if (appData.withdrawals && appData.withdrawals.length > 0) {
                appData.withdrawals.forEach(w => {
                    withdrawalList.innerHTML += `<li class="list-item withdrawal-item"><span>P${w.amount.toFixed(2)} (${w.method})</span><span class="status status-${w.status}">${w.status.toUpperCase()}</span></li>`;
                });
            } else {
                withdrawalList.innerHTML = '<li class="list-item"><p>No withdrawal history.</p></li>';
            }
        }
        
        function renderGameRooms() {
            const gameRoomsList = document.getElementById('gameRoomsList');
            gameRoomsList.innerHTML = '';
            document.querySelector('#createBetAmount').placeholder = `Min: P${MIN_GAME_BET_JS.toFixed(2)}`;
            if (appData.game_rooms && appData.game_rooms.length > 0) {
                appData.game_rooms.forEach(room => {
                    const li = document.createElement('li');
                    li.className = 'list-item game-room-item';
                    li.innerHTML = `<div><h3>Room #${room.id}</h3><p>Bet: P${room.bet.toFixed(2)}</p></div>
                                    <a class="button join-game-btn" data-room-id="${room.id}">Join</a>`;
                    gameRoomsList.appendChild(li);
                });
            } else {
                gameRoomsList.innerHTML = '<li class="list-item"><p>No open game rooms. Create one!</p></li>';
            }
        }


        // --- Event Listeners ---
        window.addEventListener('load', () => {
            if (!user?.id) {
                document.body.innerHTML = `<div style="text-align: center; padding-top: 50px;">Could not validate user. Please launch from Telegram.</div>`;
                return;
            }
            if (user.first_name) document.getElementById('welcome-message').innerText = `HEY, ${user.first_name.toUpperCase()}!`;
            fetchInitialData();
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('referralLink').innerText).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                showToast('Link Copied!');
            });
        });
        
        document.getElementById('claimDailyBonusBtn').addEventListener('click', async () => {
            if (document.getElementById('claimDailyBonusBtn').classList.contains('disabled')) return;
            try {
                await apiCall('/claim_daily_bonus', {});
                tg.showAlert(`P${DAILY_BONUS_AMOUNT_JS.toFixed(2)} has been added to your balance!`);
                fetchInitialData();
            } catch(e) {}
        });

        document.getElementById('taskList').addEventListener('click', e => {
            if (e.target.classList.contains('submit-proof-btn')) {
                currentTaskId = e.target.getAttribute('data-task-id');
                document.getElementById('taskModal').style.display = 'flex';
            }
        });
        
        document.getElementById('cancelSubmitBtn').addEventListener('click', () => { document.getElementById('taskModal').style.display = 'none'; });
        document.getElementById('taskModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; });

        document.getElementById('taskProofForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const photoInput = document.getElementById('taskProofPhoto');
            if (photoInput.files.length === 0) { tg.showAlert('Please upload a screenshot.'); return; }
            
            const reader = new FileReader();
            reader.readAsDataURL(photoInput.files[0]);
            reader.onload = async () => {
                try {
                    await apiCall('/submit_task_proof', {
                        task_id: currentTaskId,
                        text: document.getElementById('taskProofText').value,
                        photo: reader.result
                    });
                    tg.showAlert('Proof submitted for review!');
                    document.getElementById('taskModal').style.display = 'none';
                    this.reset();
                    fetchInitialData();
                } catch(e) {}
            };
            reader.onerror = () => tg.showAlert('Error reading file.');
        });

        document.getElementById('redeemCodeBtn').addEventListener('click', async () => {
            const code = document.getElementById('redeemCodeInput').value;
            if (!code) return;
            try {
                const result = await apiCall('/redeem_code', { code });
                tg.showAlert(`Success! P${result.amount_rewarded.toFixed(2)} added to your balance.`);
                document.getElementById('redeemCodeInput').value = '';
                fetchInitialData();
            } catch(e) {}
        });

        // Withdrawal Logic
        document.getElementById('gcashBtn').addEventListener('click', () => { withdrawalMethod = 'GCash'; document.getElementById('gcashBtn').classList.add('selected'); document.getElementById('mayaBtn').classList.remove('selected'); });
        document.getElementById('mayaBtn').addEventListener('click', () => { withdrawalMethod = 'Maya'; document.getElementById('mayaBtn').classList.add('selected'); document.getElementById('gcashBtn').classList.remove('selected'); });

        document.getElementById('withdrawForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (appData.withdrawal_maintenance) { tg.showAlert("Withdrawals are under maintenance."); return; }
            if (!withdrawalMethod) { tg.showAlert('Please select a withdrawal method.'); return; }

            try {
                await apiCall('/submit_withdrawal', {
                    amount: parseFloat(document.getElementById('withdrawAmount').value),
                    method: withdrawalMethod,
                    details: document.getElementById('withdrawDetails').value
                });
                tg.showAlert('Withdrawal request submitted!');
                this.reset();
                withdrawalMethod = '';
                document.getElementById('gcashBtn').classList.remove('selected');
                document.getElementById('mayaBtn').classList.remove('selected');
                document.getElementById('withdrawalFeeText').style.display = 'none';
                fetchInitialData();
            } catch(e) {}
        });

        document.getElementById('withdrawAmount').addEventListener('input', (e) => { 
            const amount = parseFloat(e.target.value) || 0; 
            const fee = amount * WITHDRAWAL_FEE_PERCENT_JS; 
            const total = amount + fee;
            const feeText = document.getElementById('withdrawalFeeText'); 
            feeText.innerText = amount > 0 ? `Fee: P${fee.toFixed(2)} | Total: P${total.toFixed(2)}` : '';
            feeText.style.display = amount > 0 ? 'block' : 'none';
        });

        // Gift Money Logic
        document.getElementById('buyTicketBtn').addEventListener('click', async () => {
            tg.showConfirm(`Buy 2 Gift Tickets for P${GIFT_TICKET_PRICE_JS.toFixed(2)}?`, async (ok) => {
                if(ok) {
                    try {
                        await apiCall('/buy_ticket', {});
                        tg.showAlert("Success! You received 2 Gift Tickets.");
                        fetchInitialData();
                    } catch(e) {}
                }
            });
        });

        document.getElementById('giftForm').addEventListener('submit', async function(e) { 
            e.preventDefault();
            try {
                await apiCall('/gift_money', {
                    recipient_id: document.getElementById('giftRecipientId').value,
                    amount: parseFloat(document.getElementById('giftAmount').value)
                });
                tg.showAlert("Gift sent successfully!");
                this.reset();
                fetchInitialData();
            } catch(e) {}
        });

        // --- Game Logic ---
        document.getElementById('createGameRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const result = await apiCall('/create_game_room', { bet: parseFloat(document.getElementById('createBetAmount').value) });
                openGamePlayModal(result.room_id, 'Waiting for an opponent...');
                setupWebSocket(result.room_id);
                fetchInitialData();
            } catch(e) {}
        });

        document.getElementById('gameRoomsList').addEventListener('click', async function(e) {
            if (e.target.classList.contains('join-game-btn')) {
                const roomId = e.target.getAttribute('data-room-id');
                try {
                    await apiCall('/join_game_room', { room_id: roomId });
                    openGamePlayModal(roomId, 'Connecting...');
                    setupWebSocket(roomId);
                } catch(e) {}
            }
        });
        
        function openGamePlayModal(roomId, statusText) {
            currentGameRoomId = roomId;
            playerMove = null;
            document.getElementById('gamePlayModal').style.display = 'flex';
            document.getElementById('gamePlayModalTitle').innerText = `ROOM #${roomId} - JACK & POY!`;
            document.getElementById('gameStatusText').innerText = statusText;
            document.getElementById('playerMoveDisplay').innerText = '?';
            document.getElementById('opponentMoveDisplay').innerText = '?';
            document.querySelectorAll('.game-choice-button').forEach(btn => {
                btn.classList.remove('disabled', 'selected');
            });
        }

        document.getElementById('cancelGameBtn').addEventListener('click', () => {
            if (gameWs) {
                gameWs.close();
                gameWs = null;
            }
            document.getElementById('gamePlayModal').style.display = 'none';
            fetchInitialData(); // Refresh UI and balance
        });

        document.querySelectorAll('.game-choice-button').forEach(button => {
            button.addEventListener('click', () => {
                if (gameWs?.readyState === WebSocket.OPEN && !playerMove) {
                    playerMove = button.getAttribute('data-move');
                    gameWs.send(JSON.stringify({ type: 'make_move', move: playerMove }));
                    document.querySelectorAll('.game-choice-button').forEach(btn => btn.classList.add('disabled'));
                    button.classList.add('selected');
                    document.getElementById('playerMoveDisplay').innerText = getEmoji(playerMove);
                    document.getElementById('gameStatusText').innerText = 'Move made. Waiting for opponent...';
                }
            });
        });

        function setupWebSocket(roomId) {
            if (gameWs) gameWs.close();
            
            const wsProtocol = API_BASE_URL.startsWith('https') ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${API_BASE_URL.split('//')[1]}/ws/${roomId}/${user.id}`;
            gameWs = new WebSocket(wsUrl);

            gameWs.onopen = () => console.log("WebSocket connected.");
            gameWs.onmessage = (event) => handleGameMessage(JSON.parse(event.data));
            gameWs.onclose = () => { console.log("WebSocket closed."); gameWs = null; };
            gameWs.onerror = (error) => { console.error("WebSocket error:", error); tg.showAlert('Game connection error.'); };
        }
        
        function handleGameMessage(msg) {
            console.log("WS message:", msg);
            const statusText = document.getElementById('gameStatusText');
            if (msg.type === 'game_start') {
                statusText.innerText = 'Game started! Make your move!';
            } else if (msg.type === 'move_made') {
                if (msg.user_id != user.id) {
                    statusText.innerText = 'Opponent has moved!';
                }
            } else if (msg.type === 'game_over') {
                document.getElementById('playerMoveDisplay').innerText = getEmoji(msg.creator_id == user.id ? msg.creator_move : msg.opponent_move);
                document.getElementById('opponentMoveDisplay').innerText = getEmoji(msg.creator_id == user.id ? msg.opponent_move : msg.creator_move);

                if (msg.winner == user.id) statusText.innerText = `YOU WIN! 🎉`;
                else if (msg.winner == -1) statusText.innerText = `IT'S A DRAW! 🤝`;
                else statusText.innerText = `YOU LOSE! 😭`;

                setTimeout(() => {
                    document.getElementById('gamePlayModal').style.display = 'none';
                    fetchInitialData();
                }, 3000);
            } else if (msg.type === 'error') {
                tg.showAlert(msg.message);
                document.getElementById('gamePlayModal').style.display = 'none';
            }
        }

        function getEmoji(move) {
            return { rock: '✊', paper: '✋', scissors: '✌️' }[move] || '?';
        }
        
    </script>
</body>
</html>
