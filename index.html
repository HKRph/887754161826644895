<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GTaskPH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #212121);
            --tg-text: var(--tg-theme-text-color, #eeeeee);
            --tg-hint: var(--tg-theme-hint-color, #9e9e9e);
            --tg-button: var(--tg-theme-button-color, #42a5f5);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #303030);
            --pixel-border-light: #424242;
            --pixel-border-dark: #000000;
            --accent-green: #00e676; --accent-red: #ff5252; --accent-yellow: #ffea00;
            --game-rock: #f85555; --game-paper: #42a5f5; --game-scissors: #00e676;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toastIn { from { opacity: 0; bottom: 60px; } to { opacity: 1; bottom: 80px; } }
        @keyframes toastOut { to { opacity: 0; bottom: 60px; } }
        body { font-family: 'VT323', monospace; padding: 10px 10px 80px 10px; margin: 0; color: var(--tg-text); background-color: var(--tg-bg); -webkit-font-smoothing: none; image-rendering: pixelated; animation: fadeIn 0.5s; }
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s; }
        .pixel-container { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 15px; margin-bottom: 15px; }
        .header h1 { font-size: 28px; margin: 0 0 10px 0; } .header p { font-size: 18px; color: var(--tg-hint); margin: 0; }
        .balance-card h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--tg-hint); } .balance-card .balance-amount { font-size: 42px; color: var(--accent-yellow); }
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; margin-bottom: 15px; }
        .list-item h3 { margin: 0 0 8px 0; font-size: 20px; } .list-item p { margin: 0 0 12px 0; font-size: 16px; color: var(--tg-hint); }
        .button { padding: 12px; border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-button); color: var(--tg-button-text); font-size: 18px; font-family: 'VT323', monospace; cursor: pointer; text-align: center; } .button:active { border-color: var(--pixel-border-light); border-right-color: var(--pixel-border-dark); border-bottom-color: var(--pixel-border-dark); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .stat-card { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-bg); padding: 15px; text-align: center; } .stat-card .value { font-size: 28px; } .stat-card .label { font-size: 16px; color: var(--tg-hint); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--tg-secondary-bg); border-top: 3px solid var(--pixel-border-light); padding: 5px 0; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: var(--tg-hint); cursor: pointer; padding: 5px 0; }
        .nav-item .icon { font-size: 24px; } .nav-item .label { font-size: 12px; }
        .nav-item.active { filter: drop-shadow(0 0 3px var(--tg-button)); color: var(--tg-text); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; font-size: 24px; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { border: 3px solid var(--pixel-border-dark); border-right-color: var(--pixel-border-light); border-bottom-color: var(--pixel-border-light); background: var(--tg-secondary-bg); padding: 20px; width: 90%; max-width: 400px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; font-size: 18px; margin-bottom: 8px; } .form-group input, .form-group textarea { width: 100%; padding: 10px; font-size: 18px; font-family: 'VT323', monospace; border: 3px solid var(--pixel-border-dark); background-color: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--tg-secondary-bg); color: var(--tg-text); padding: 15px; z-index: 2000; border: 3px solid var(--pixel-border-light); font-size: 18px; animation: toastIn 0.3s, toastOut 0.3s 2.2s; }
        .withdrawal-item .status { float: right; font-weight: 600; font-size: 16px; } .status-pending { color: var(--accent-yellow); } .status-approved { color: var(--accent-green); } .status-rejected { color: var(--accent-red); }
        .daily-bonus-card .button.disabled { background-color: var(--tg-hint); cursor: not-allowed; opacity: 0.7; }
        .daily-bonus-card .progress-bar { height: 10px; background-color: var(--tg-bg); border: 2px solid var(--pixel-border-dark); margin-top: 10px; }
        .daily-bonus-card .progress-fill { height: 100%; width: 0%; background-color: var(--accent-green); transition: width 0.5s ease-in-out; }
        .task-milestone-card .milestone-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 16px; }
        .task-milestone-card .milestone-item .reward { color: var(--accent-yellow); }
        .task-milestone-card .milestone-item .claimed { color: var(--accent-green); }
        .method-selector { display: flex; gap: 10px; } .method-selector button { flex-grow: 1; padding: 12px; border: 3px solid var(--pixel-border-dark); background-color: var(--tg-bg); color: var(--tg-text); font-size: 18px; font-family: 'VT323', monospace; cursor: pointer; } .method-selector button.selected { background-color: var(--tg-text); color: var(--tg-bg); }
        .withdrawal-maintenance-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; color: white; text-align: center; font-size: 20px; }
        /* Game specific styles */
        .game-room-item { display: flex; justify-content: space-between; align-items: center; }
        .game-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .game-choice-button { flex: 1; padding: 20px; font-size: 40px; background: var(--tg-bg); border: 3px solid var(--pixel-border-dark); }
        .game-choice-button.selected { border-color: var(--tg-button); }
        .game-result { text-align: center; margin-top: 20px; font-size: 24px; }
        .game-move { font-size: 36px; margin: 10px; }
        .game-moves-display { display: flex; justify-content: space-around; margin-top: 20px; font-size: 24px; }
        .game-status-box { text-align: center; margin-bottom: 20px; font-size: 18px; color: var(--accent-yellow); }
        .game-result-box { text-align: center; margin-top: 20px; font-size: 24px; font-weight: bold; color: var(--tg-text); }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay" style="display: flex;">
        <span style="display:inline-block; animation: blink 1s infinite;">LOADING...</span>
        <style>@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }</style>
    </div>

    <!-- Home View -->
    <div id="homeView" class="app-view active">
        <div class="header"> <h1 id="welcome-message">GTaskPH</h1> <p>Your Pixel Quest for Rewards!</p> </div>
        <div class="pixel-container balance-card"> <h2>Balance</h2> <p id="balanceAmount" class="balance-amount">P--.--</p> </div>
        
        <div class="pixel-container daily-bonus-card">
            <h3>Daily Login Bonus</h3>
            <p id="dailyBonusStatus" style="font-size: 16px; margin-bottom: 10px; color: var(--tg-hint);">Loading...</p>
            <div class="progress-bar"><div id="dailyBonusProgress" class="progress-fill"></div></div>
            <a id="claimDailyBonusBtn" class="button" style="margin-top: 15px;">Claim Bonus (P10.00)</a>
        </div>

        <div class="pixel-container announcement-card"> <h3>Announcements</h3> <p id="announcementText">Loading latest news...</p> </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="app-view">
        <div class="header"> <h1>Task Board</h1> </div>
        <ul id="taskList" class="list"></ul>
    </div>

    <!-- Referrals View -->
    <div id="referralView" class="app-view">
        <div class="header"> <h1>Invite Allies</h1> </div>
        <div class="stats-grid">
            <div class="stat-card"> <div id="referralCount" class="value">0</div> <div class="label">Allies Recruited</div> </div>
            <div class="stat-card"> <div id="successfulReferralCount" class="value">0</div> <div class="label">Successful Quests</div> </div>
        </div>
        <br>
        <div class="pixel-container">
            <h3>Your Unique Scroll</h3>
            <p style="font-size: 16px; line-height: 1.5;">Share this scroll. For every ally who joins and completes their first quest, you earn <strong>P77.00</strong>!</p>
            <div id="referralLink" style="background: var(--tg-bg); padding: 10px; word-wrap: break-word; font-size: 14px; margin: 15px 0; border: 2px inset var(--pixel-border-dark);"></div>
            <a id="copyLinkBtn" class="button">Copy Scroll</a>
        </div>
    </div>
    
    <!-- Gift View -->
    <div id="giftView" class="app-view">
        <div class="header"> <h1>Gift Treasury</h1> </div>
        <div class="pixel-container">
            <h3>Your Gift Tickets</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <span id="giftTicketCount" style="font-size: 42px; color: var(--accent-yellow);">0</span>
                <p style="color: var(--tg-hint); font-size: 16px; margin-top: 5px;">Tickets Available</p>
            </div>
            <a id="buyTicketBtn" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark);">Buy Tickets (P77.00 - B1G1)</a>
        </div>
        <div class="pixel-container">
            <h3>Send a Gift</h3>
            <p style="font-size: 16px; line-height: 1.5;">Uses 1 Ticket. A 5% fee applies to the sent amount from your balance.</p>
            <form id="giftForm">
                <div class="form-group"><label for="giftRecipientId">Recipient User ID</label><input type="number" id="giftRecipientId" placeholder="e.g., 123456789"></div>
                <div class="form-group"><label for="giftAmount">Amount (Min: P300)</label><input type="number" id="giftAmount" placeholder="e.g., 500"></div>
                <button type="submit" class="button">Send Gift</button>
            </form>
        </div>
    </div>

    <!-- Games View (Jack and Poy) -->
    <div id="gamesView" class="app-view">
        <div class="header"> <h1>Arcade</h1> <p>Play Jack & Poy!</p> </div>
        <div class="pixel-container">
            <h3>Create New Room</h3>
            <p style="font-size: 16px; line-height: 1.5;">Bet your coins against other players. Winner takes all (minus 10% fee).</p>
            <form id="createGameRoomForm">
                <div class="form-group"><label for="createBetAmount">Bet Amount (Min: P10)</label><input type="number" id="createBetAmount" placeholder="e.g., 50"></div>
                <button type="submit" class="button" style="background: var(--accent-yellow); color: var(--pixel-border-dark);">Create Room</button>
            </form>
        </div>
        <div class="pixel-container">
            <h3>Open Rooms</h3>
            <ul id="gameRoomsList" class="list"></ul>
        </div>
    </div>

    <!-- Game Play Modal -->
    <div id="gamePlayModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="gamePlayModalTitle" style="font-size: 20px;">Jack & Poy!</h2>
            <p id="gameStatusText" style="font-size: 18px; margin-bottom: 20px;">Connecting to game...</p>
            <div id="gameMoves" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div id="playerMoveDisplay" class="game-move">?</div>
                <div id="opponentMoveDisplay" class="game-move">?</div>
            </div>
            <div id="gameChoices" style="display: flex; gap: 10px;">
                <button class="button game-choice-button" data-move="rock">✊</button>
                <button class="button game-choice-button" data-move="paper">✋</button>
                <button class="button game-choice-button" data-move="scissors">✌️</button>
            </div>
            <a id="cancelGameBtn" class="button" style="background: var(--accent-red); margin-top: 15px;">Leave Game</a>
        </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="app-view">
        <div class="header"> <h1>Player Info</h1> </div>
        <div class="pixel-container">
            <p id="profileName" style="font-size: 18px;">Player: ...</p>
            <p id="profileId" style="font-size: 14px; color: var(--tg-hint);">ID: ...</p>
            <p id="tasksCompleted" style="font-size: 14px; color: var(--tg-hint);">Tasks Completed: 0</p>
        </div>
        <div class="pixel-container task-milestone-card">
            <h3>Task Milestones</h3>
            <div id="taskMilestonesList"></div>
        </div>
        <div class="pixel-container">
            <h3>Redeem Scroll</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input id="redeemCodeInput" type="text" placeholder="Enter Code" style="flex-grow: 1; margin: 0;">
                <a id="redeemCodeBtn" class="button" style="padding: 10px 15px;">OK</a>
            </div>
        </div>
        <div class="pixel-container" style="position: relative;">
            <div id="withdrawalMaintenanceOverlay" class="withdrawal-maintenance-overlay" style="display:none;">WITHDRAWAL<br>MAINTENANCE</div>
            <h3>Withdraw Funds</h3>
            <p style="font-size: 16px; line-height: 1.5;"><span id="minWithdrawalText">Min: P300.00</span>, <span id="maxWithdrawalText">Max: P30000.00</span></p>
            <form id="withdrawForm">
                <div class="form-group"><label for="withdrawAmount">Amount</label><input type="number" id="withdrawAmount" placeholder="e.g., 500"></div>
                <div class="form-group"><label>Method</label><div class="method-selector"><button type="button" id="gcashBtn">GCASH</button><button type="button" id="mayaBtn">MAYA</button></div></div>
                <div class="form-group"><label for="withdrawDetails">Account Number</label><input type="tel" id="withdrawDetails" placeholder="Your GCash/Maya number"></div>
                <p id="withdrawalFeeText" style="font-size: 14px; color: var(--tg-hint); text-align: center; display: none;"></p>
                <button type="submit" class="button" style="background: var(--accent-red); color: var(--tg-button-text); margin-top: 10px;">Submit Withdrawal</button>
            </form>
        </div>
        <div class="pixel-container">
            <h3>Withdrawal History</h3>
            <ul id="withdrawalList" class="list" style="max-height: 150px; overflow-y: auto;"></ul>
        </div>
    </div>

    <!-- Task Submission Modal -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="taskModalTitle" style="font-size: 20px;">Submit Proof</h2>
            <form id="taskProofForm">
                <div class="form-group"><label for="taskProofText">Note (Optional)</label><textarea id="taskProofText" rows="2"></textarea></div>
                <div class="form-group"><label for="taskProofPhoto">Upload Image Proof</label><input type="file" id="taskProofPhoto" accept="image/*" required></div>
                <div style="display: flex; gap: 10px;"><a id="cancelSubmitBtn" class="button" style="background: var(--tg-hint); flex:1;">Cancel</a><button type="submit" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark); flex:1;">Submit</button></div>
            </form>
        </div>
    </div>

    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showView('homeView')"> <div class="icon">🏠</div> <div class="label">Home</div> </div>
        <div id="navTasks" class="nav-item" onclick="showView('tasksView')"> <div class="icon">📜</div> <div class="label">Tasks</div> </div>
        <div id="navReferral" class="nav-item" onclick="showView('referralView')"> <div class="icon">🤝</div> <div class="label">Refer</div> </div>
        <div id="navGift" class="nav-item" onclick="showView('giftView')"> <div class="icon">🎁</div> <div class="label">Gift</div> </div>
        <div id="navGames" class="nav-item" onclick="showView('gamesView')"> <div class="icon">🎮</div> <div class="label">Games</div> </div>
        <div id="navProfile" class="nav-item" onclick="showView('profileView')"> <div class="icon">👤</div> <div class="label">Profile</div> </div>
    </nav>
    
    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        
        // YOUR FINAL RAILWAY BACKEND URL IS HERE
        const API_BASE_URL = "https://64628638262626-production.up.railway.app"; 
        const BOT_USERNAME = "GTaskPHBot";
        const user = tg.initDataUnsafe.user;
        const initData = tg.initData;

        let appData = {}; 
        let withdrawalMethod = '';

        // These constants are dynamic, fetched from backend
        let MIN_WITHDRAWAL_JS = 300; 
        let MAX_WITHDRAWAL_JS = 30000;
        let WITHDRAWAL_FEE_PERCENT_JS = 0.03;
        let DAILY_BONUS_INVITE_REQ_JS = 2;
        let DAILY_BONUS_AMOUNT_JS = 10;
        let GIFT_TICKET_PRICE_JS = 77;
        let GIFT_MIN_AMOUNT_JS = 300;
        let GIFT_MAX_AMOUNT_JS = 80000;
        let GIFT_FEE_PERCENT_JS = 0.05;
        let MIN_GAME_BET_JS = 10;
        const TASK_MILESTONES_UI = {10: 50.0, 20: 150.0, 30: 400.0}; // Still hardcoded for display purposes

        const views = document.querySelectorAll('.app-view');
        const navItems = document.querySelectorAll('.nav-item');
        function showView(viewId) { 
            tg.HapticFeedback.impactOccurred('light'); 
            views.forEach(v => v.classList.remove('active')); 
            document.getElementById(viewId).classList.add('active'); 
            navItems.forEach(n => n.classList.remove('active')); 
            try { 
                const navId = `nav${viewId.replace('View', '').replace('sView', '')}`; // Handles 'gamesView' -> 'navGame'
                document.getElementById(navId).classList.add('active'); 
            } catch (e) {
                console.error("Error setting active nav item:", e);
            }
            if (viewId === 'gamesView') {
                fetchInitialData(); // Refresh data including game rooms
            }
        }

        function showToast(message) { 
            const toast = document.createElement('div'); 
            toast.className = 'toast'; toast.innerText = message; 
            document.body.appendChild(toast); 
            setTimeout(() => { toast.remove(); }, 2500); 
        }
        
        async function fetchInitialData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/get_initial_data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData }) });
                if (!response.ok) { 
                    const errorData = await response.json(); 
                    throw new Error(errorData.detail || `Network response was not ok: ${response.status}`); 
                }
                const data = await response.json();
                if(data.error) { 
                    tg.showAlert(data.detail || data.error); 
                    // Do not close app on soft errors, allow user to see status
                    return;
                }
                appData = data;
                
                // Update dynamic constants from backend for UI
                MIN_WITHDRAWAL_JS = data.min_withdrawal;
                MAX_WITHDRAWAL_JS = data.max_withdrawal;
                WITHDRAWAL_FEE_PERCENT_JS = data.withdrawal_fee_percent;
                DAILY_BONUS_INVITE_REQ_JS = data.daily_bonus_req;
                DAILY_BONUS_AMOUNT_JS = data.daily_bonus_amount; 
                GIFT_TICKET_PRICE_JS = data.gift_ticket_price;
                GIFT_MIN_AMOUNT_JS = data.gift_min_amount;
                GIFT_MAX_AMOUNT_JS = data.gift_max_amount;
                GIFT_FEE_PERCENT_JS = data.gift_fee_percent;
                MIN_GAME_BET_JS = data.min_game_bet;
                
                // Set withdrawal maintenance mode
                const withdrawalMaintenanceOverlay = document.getElementById('withdrawalMaintenanceOverlay');
                if (appData.withdrawal_maintenance) { withdrawalMaintenanceOverlay.style.display = 'flex'; } else { withdrawalMaintenanceOverlay.style.display = 'none'; }

                renderAll();
            } catch (error) { 
                tg.showAlert(error.message || 'COULD NOT LOAD DATA. PLEASE RESTART.'); 
            } finally { document.getElementById('loading').style.display = 'none'; }
        }

        function renderAll(){
            // Home View
            document.getElementById('balanceAmount').innerText = `P${(appData.balance || 0).toFixed(2)}`;
            document.getElementById('announcementText').innerText = appData.announcement || "Welcome! No new announcements at this time.";

            // Daily Bonus
            const claimBtn = document.getElementById('claimDailyBonusBtn');
            const dailyBonusStatus = document.getElementById('dailyBonusStatus');
            const dailyBonusProgress = document.getElementById('dailyBonusProgress');

            if (appData.can_claim_daily) {
                claimBtn.classList.remove('disabled');
                claimBtn.innerText = `Claim Bonus (P${DAILY_BONUS_AMOUNT_JS.toFixed(2)})`;
                dailyBonusStatus.innerText = 'Ready to Claim!';
                dailyBonusProgress.style.width = '100%';
            } else {
                claimBtn.classList.add('disabled');
                const invitesNeeded = Math.max(0, DAILY_BONUS_INVITE_REQ_JS - appData.daily_claim_invites);
                claimBtn.innerText = `Invite ${invitesNeeded} more allies to claim!`;
                dailyBonusStatus.innerText = `Invites: ${appData.daily_claim_invites}/${DAILY_BONUS_INVITE_REQ_JS}`;
                dailyBonusProgress.style.width = `${(appData.daily_claim_invites / DAILY_BONUS_INVITE_REQ_JS) * 100}%`;
            }

            // Tasks View
            const taskList = document.getElementById('taskList'); taskList.innerHTML = '';
            if (appData.tasks && appData.tasks.length > 0) { 
                appData.tasks.forEach(task => { 
                    const li = document.createElement('li'); li.className = 'list-item'; 
                    li.innerHTML = `<h3>${task.description}</h3><p>REWARD: P${task.reward.toFixed(2)}</p>
                                    <div style="display:flex; gap: 10px; margin-top: 15px;">
                                        <a href="${task.link}" target="_blank" class="button" style="flex:1;">Visit Link</a>
                                        <a class="button submit-proof-btn" data-task-id="${task.id}" style="flex:1; background: var(--accent-green); color: var(--pixel-border-dark);">Submit Proof</a>
                                    </div>`; 
                    taskList.appendChild(li); 
                }); 
            } else { taskList.innerHTML = '<li class="list-item"><p>No tasks available right now. Check back later!</p></li>'; }

            // Referrals View
            document.getElementById('referralCount').innerText = appData.referral_count || 0;
            document.getElementById('successfulReferralCount').innerText = appData.successful_referrals || 0;
            document.getElementById('referralLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            
            // Gift View
            document.getElementById('giftTicketCount').innerText = appData.gift_tickets || 0;
            document.querySelector('#buyTicketBtn').innerText = `Buy Tickets (P${GIFT_TICKET_PRICE_JS.toFixed(2)} - B1G1)`;
            document.querySelector('#giftAmount').placeholder = `Min: P${GIFT_MIN_AMOUNT_JS.toFixed(2)}`;

            // Games View - Rooms
            renderGameRooms();

            // Profile View
            document.getElementById('profileName').innerText = `Player: ${user.first_name || 'Unknown'}`;
            document.getElementById('profileId').innerText = `ID: ${user.id}`;
            document.getElementById('tasksCompleted').innerText = `Tasks Completed: ${appData.tasks_completed || 0}`;

            // Task Milestones
            const milestonesList = document.getElementById('taskMilestonesList');
            milestonesList.innerHTML = '';
            const claimedMilestones = appData.claimed_milestones || {};
            
            for (const milestone in TASK_MILESTONES_UI) {
                const count = parseInt(milestone.split('_')[0]);
                const reward = TASK_MILESTONES_UI[milestone];
                const isClaimed = claimedMilestones[milestone];
                const currentStatus = (appData.tasks_completed >= count) ? (isClaimed ? 'CLAIMED' : 'READY') : 'PENDING';
                const statusColor = isClaimed ? 'var(--accent-green)' : (appData.tasks_completed >= count ? 'var(--accent-yellow)' : 'var(--tg-hint)');

                const item = document.createElement('div');
                item.className = 'milestone-item';
                item.innerHTML = `
                    <span>${count} Tasks:</span>
                    <span style="color: ${statusColor};">P${reward.toFixed(2)} (${currentStatus})</span>
                `;
                milestonesList.appendChild(item);
            }

            // Withdrawal Section in Profile
            document.getElementById('minWithdrawalText').innerText = `Min: P${MIN_WITHDRAWAL_JS.toFixed(2)}`;
            document.getElementById('maxWithdrawalText').innerText = `Max: P${MAX_WITHDRAWAL_JS.toFixed(2)}`;
            document.getElementById('withdrawAmount').placeholder = `e.g., ${MIN_WITHDRAWAL_JS.toFixed(2)}`;

            const withdrawalMaintenanceOverlay = document.getElementById('withdrawalMaintenanceOverlay');
            if (appData.withdrawal_maintenance) { withdrawalMaintenanceOverlay.style.display = 'flex'; } else { withdrawalMaintenanceOverlay.style.display = 'none'; }

            // Withdrawal History
            const withdrawalList = document.getElementById('withdrawalList'); withdrawalList.innerHTML = '';
            if (appData.withdrawals && appData.withdrawals.length > 0) { 
                appData.withdrawals.forEach(w => { 
                    const item = document.createElement('li'); item.className = 'list-item'; 
                    item.innerHTML = `<span>P${w.amount.toFixed(2)} (${w.method}) on ${w.date}</span><span class="status status-${w.status}">${w.status.toUpperCase()}</span>`; 
                    withdrawalList.appendChild(item); 
                }); 
            } else { withdrawalList.innerHTML = '<li class="list-item"><p>No withdrawal history.</p></li>'; }
        }
        
        // --- Game Room Rendering ---
        function renderGameRooms() {
            const gameRoomsList = document.getElementById('gameRoomsList');
            gameRoomsList.innerHTML = '';
            document.querySelector('#createBetAmount').placeholder = `Min: P${MIN_GAME_BET_JS.toFixed(2)}`;

            if (appData.game_rooms && appData.game_rooms.length > 0) {
                appData.game_rooms.forEach(room => {
                    const li = document.createElement('li'); li.className = 'list-item game-room-item';
                    li.innerHTML = `
                        <div>
                            <h3>Room #${room.id}</h3>
                            <p>Bet: P${room.bet.toFixed(2)}</p>
                            <p>Creator: ${room.creator_id}</p>
                        </div>
                        <a class="button join-game-btn" data-room-id="${room.id}" style="width: auto; padding: 8px 12px; background: var(--tg-button);">Join</a>
                    `;
                    gameRoomsList.appendChild(li);
                });
            } else {
                gameRoomsList.innerHTML = '<li class="list-item"><p>No open game rooms. Create one!</p></li>';
            }
        }


        // --- Event Listeners ---
        window.addEventListener('load', fetchInitialData);
        if (user && user.first_name) document.getElementById('welcome-message').innerText = `HEY, ${user.first_name}!`;
        document.getElementById('copyLinkBtn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('referralLink').innerText).then(() => { tg.HapticFeedback.notificationOccurred('success'); showToast('Link Copied!'); }); });
        
        document.getElementById('claimDailyBonusBtn').addEventListener('click', async () => {
            if (document.getElementById('claimDailyBonusBtn').classList.contains('disabled')) {
                tg.showAlert("You must meet the invite requirements or wait until tomorrow to claim.");
                return;
            }
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/claim_daily_bonus`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Failed to claim bonus.'); }
                tg.showAlert(`P${DAILY_BONUS_AMOUNT_JS.toFixed(2)} has been added to your balance!`);
                fetchInitialData(); // Refresh data
            } catch (error) { tg.showAlert(error.message || 'Could not claim daily bonus.'); } finally { document.getElementById('loading').style.display = 'none'; }
        });

        document.getElementById('taskList').addEventListener('click', e => { 
            if (e.target.classList.contains('submit-proof-btn')) { 
                const taskId = e.target.getAttribute('data-task-id');
                // Check if task is already completed based on current appData.tasks
                const task = appData.tasks.find(t => t.id == taskId);
                if (!task) { // If task is no longer in available tasks, it's completed (or not found)
                     tg.showAlert('You have already completed this task or it is no longer available.');
                     fetchInitialData(); // Refresh in case data is stale
                     return;
                }
                openTaskModal(taskId); 
            }
        });
        const taskModal = document.getElementById('taskModal'); let currentTaskId = null;
        function openTaskModal(taskId) { currentTaskId = taskId; taskModal.style.display = 'flex'; }
        document.getElementById('cancelSubmitBtn').addEventListener('click', () => { taskModal.style.display = 'none'; });
        taskModal.addEventListener('click', (e) => { if (e.target === taskModal) taskModal.style.display = 'none'; });

        document.getElementById('taskProofForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = document.getElementById('taskProofText').value;
            const photoInput = document.getElementById('taskProofPhoto');
            if (photoInput.files.length === 0) { tg.showAlert('Please upload a screenshot.'); return; }
            
            const reader = new FileReader();
            reader.readAsDataURL(photoInput.files[0]);
            reader.onload = async () => {
                document.getElementById('loading').style.display = 'flex';
                try {
                    const response = await fetch(`${API_BASE_URL}/submit_task_proof`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, task_id: currentTaskId, text, photo: reader.result }) });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Submission failed.'); }
                    tg.showAlert('Proof submitted for review!'); taskModal.style.display = 'none';
                    fetchInitialData(); // Refresh data to hide completed tasks
                } catch (error) { tg.showAlert(error.message || 'Submission failed.'); } finally { document.getElementById('loading').style.display = 'none'; }
            };
            reader.onerror = () => { tg.showAlert('Error reading file.'); };
        });

        document.getElementById('redeemCodeBtn').addEventListener('click', async () => {
            const code = document.getElementById('redeemCodeInput').value; if (!code) { return; }
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/redeem_code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, code }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Invalid code.'); }
                const result = await response.json();
                tg.showAlert(`Success! P${result.amount_rewarded.toFixed(2)} added to your balance.`);
                fetchInitialData(); // Refresh data
            } catch (error) { tg.showAlert(error.message || 'Invalid code.'); } finally { document.getElementById('loading').style.display = 'none'; }
        });

        // Withdrawal Logic
        let withdrawalMethod = '';
        document.getElementById('gcashBtn').addEventListener('click', () => { withdrawalMethod = 'GCash'; document.getElementById('gcashBtn').classList.add('selected'); document.getElementById('mayaBtn').classList.remove('selected'); });
        document.getElementById('mayaBtn').addEventListener('click', () => { withdrawalMethod = 'Maya'; document.getElementById('mayaBtn').classList.add('selected'); document.getElementById('gcashBtn').classList.remove('selected'); });

        document.getElementById('withdrawForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Check if withdrawal is under maintenance
            if (appData.withdrawal_maintenance) {
                tg.showAlert("Withdrawals are currently under maintenance. Please try again later.");
                return;
            }

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const details = document.getElementById('withdrawDetails').value;

            if (isNaN(amount) || amount < MIN_WITHDRAWAL_JS || amount > MAX_WITHDRAWAL_JS) { tg.showAlert(`Amount must be between P${MIN_WITHDRAWAL_JS.toFixed(2)} and P${MAX_WITHDRAWAL_JS.toFixed(2)}.`); return; }
            if (amount * (1 + WITHDRAWAL_FEE_PERCENT_JS) > appData.balance) { tg.showAlert('Insufficient balance to cover amount and fee.'); return; }
            if (!withdrawalMethod) { tg.showAlert('Please select a withdrawal method.'); return; }
            if (!details) { tg.showAlert('Please enter your account number.'); return; }

            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/submit_withdrawal`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, amount, method: withdrawalMethod, details }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Submission failed.'); }
                tg.showAlert('Withdrawal request submitted!');
                fetchInitialData(); // Refresh data
                document.getElementById('withdrawForm').reset();
                withdrawalMethod = '';
                document.getElementById('gcashBtn').classList.remove('selected');
                document.getElementById('mayaBtn').classList.remove('selected');
                document.getElementById('withdrawalFeeText').style.display = 'none';
            } catch (error) { tg.showAlert(error.message || 'Withdrawal failed. Please try again.'); } finally { document.getElementById('loading').style.display = 'none'; }
        });
        document.getElementById('withdrawAmount').addEventListener('input', (e) => { 
            const amount = parseFloat(e.target.value) || 0; 
            const fee = amount * (appData.withdrawal_fee_percent || 0.03); 
            const totalDeduction = amount + fee;
            const feeText = document.getElementById('withdrawalFeeText'); 
            if(amount > 0) { 
                feeText.innerText = `Fee: P${fee.toFixed(2)} | Total deducted: P${totalDeduction.toFixed(2)}`; 
                feeText.style.display = 'block'; 
            } else { 
                feeText.style.display = 'none'; 
            } 
        });

        // Gift Money Logic
        document.getElementById('buyTicketBtn').addEventListener('click', async () => { 
            tg.showConfirm(`Buy 1 Gift Ticket for P${appData.gift_ticket_price.toFixed(2)} and get 1 FREE? Total: 2 Tickets for P${appData.gift_ticket_price.toFixed(2)}.`, async (ok) => { 
                if(ok){ 
                    document.getElementById('loading').style.display = 'flex'; 
                    try { 
                        const response = await fetch(`${API_BASE_URL}/buy_ticket`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData }) }); 
                        if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Purchase failed.'); } 
                        tg.showAlert("Success! You received 2 Gift Tickets."); 
                        fetchInitialData(); 
                    } catch(e) { tg.showAlert(e.message); } finally { document.getElementById('loading').style.display = 'none'; } 
                } 
            }); 
        });

        document.getElementById('giftForm').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            const recipient_id = document.getElementById('giftRecipientId').value; 
            const amount = parseFloat(document.getElementById('giftAmount').value); 
            if(!recipient_id || isNaN(amount)) { tg.showAlert("Please fill all fields correctly."); return; } 
            if(appData.gift_tickets < 1) { tg.showAlert("You do not have any Gift Tickets to use."); return; } 
            if(amount < appData.gift_min_amount || amount > appData.gift_max_amount) { tg.showAlert(`Amount must be between P${appData.gift_min_amount.toFixed(2)} and P${appData.gift_max_amount.toFixed(2)}.`); return; }
            if(amount * (1 + appData.gift_fee_percent) > appData.balance) { tg.showAlert('Insufficient balance to cover gift amount and fee.'); return; }
            
            document.getElementById('loading').style.display = 'flex'; 
            try { 
                const response = await fetch(`${API_BASE_URL}/gift_money`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, recipient_id, amount }) }); 
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Gifting failed.'); } 
                tg.showAlert("Gift sent successfully!"); 
                fetchInitialData(); 
                document.getElementById('giftForm').reset();
            } catch(e) { tg.showAlert(e.message); } finally { document.getElementById('loading').style.display = 'none'; } 
        });

        // Game Logic (WebSockets)
        const gamePlayModal = document.getElementById('gamePlayModal');
        let gameWs = null; // Dedicated WebSocket for game play
        let currentGameRoomId = null; 
        let playerMove = null; // Stores player's chosen move
        
        const gameChoices = document.querySelectorAll('.game-choice-button');
        const gameStatusText = document.getElementById('gameStatusText');
        const playerMoveDisplay = document.getElementById('playerMoveDisplay');
        const opponentMoveDisplay = document.getElementById('opponentMoveDisplay');


        document.getElementById('createGameRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bet = parseFloat(document.getElementById('createBetAmount').value);
            if (isNaN(bet) || bet < appData.min_game_bet) { tg.showAlert(`Min bet is P${appData.min_game_bet.toFixed(2)}.`); return; }
            if (bet > appData.balance) { tg.showAlert('Insufficient balance.'); return; }
            
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch(`${API_BASE_URL}/create_game_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, bet }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Failed to create room.'); }
                const result = await response.json();
                tg.showAlert(`Game room #${result.room_id} created! Waiting for opponent.`);
                fetchInitialData(); // Refresh rooms list
                // Optionally auto-join creator to their own room's websocket
                currentGameRoomId = result.room_id;
                openGamePlayModal(result.room_id);
                setupWebSocket(result.room_id);
                gameStatusText.innerText = 'Room created. Waiting for opponent...';

            } catch (error) { tg.showAlert(error.message || 'Failed to create room.'); } finally { document.getElementById('loading').style.display = 'none'; }
        });

        document.getElementById('gameRoomsList').addEventListener('click', async function(e) {
            if (e.target.classList.contains('join-game-btn')) {
                const roomId = e.target.getAttribute('data-room-id');
                document.getElementById('loading').style.display = 'flex';
                try {
                    const response = await fetch(`${API_BASE_URL}/join_game_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: user.id, _auth: initData, room_id: roomId }) });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Failed to join room.'); }
                    
                    currentGameRoomId = roomId;
                    openGamePlayModal(roomId);
                    setupWebSocket(roomId);

                } catch (error) { tg.showAlert(error.message || 'Failed to join room.'); } finally { document.getElementById('loading').style.display = 'none'; }
            }
        });
        
        function openGamePlayModal(roomId) {
            gamePlayModal.style.display = 'flex';
            document.getElementById('gamePlayModalTitle').innerText = `ROOM #${roomId} - JACK & POY!`;
            gameStatusText.innerText = 'Connecting to game...';
            playerMoveDisplay.innerText = '?';
            opponentMoveDisplay.innerText = '?';
            gameChoices.forEach(btn => {
                btn.classList.remove('disabled');
                btn.classList.remove('selected');
            });
            playerMove = null; // Reset player's move
            opponentMove = null; // Reset opponent's move
        }

        document.getElementById('cancelGameBtn').addEventListener('click', () => {
            if (gameWs) {
                gameWs.close(); // This will trigger disconnect on backend
                gameWs = null;
            }
            currentGameRoomId = null;
            gamePlayModal.style.display = 'none';
            fetchInitialData(); // Refresh UI
        });

        gameChoices.forEach(button => {
            button.addEventListener('click', async () => {
                const move = button.getAttribute('data-move');
                if (gameWs && gameWs.readyState === WebSocket.OPEN && currentGameRoomId && !playerMove) { // Only allow move if not already made
                    playerMove = move;
                    gameChoices.forEach(btn => btn.classList.add('disabled')); // Disable all choices after one is made
                    button.classList.add('selected'); // Highlight selected move
                    playerMoveDisplay.innerText = getEmoji(move);
                    await gameWs.send(JSON.stringify({ type: 'make_move', move: move }));
                    gameStatusText.innerText = 'Move made. Waiting for opponent...';
                } else if (playerMove) {
                    showToast('You already made your move!');
                } else {
                    tg.showAlert('Game not active or connection lost. Please leave and rejoin.');
                }
            });
        });

        function setupWebSocket(roomId) {
            if (gameWs) gameWs.close(); // Close any existing connection

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${API_BASE_URL.split('//')[1]}/ws/${roomId}/${user.id}`; // Ensure correct WebSocket URL
            gameWs = new WebSocket(wsUrl);

            gameWs.onopen = (event) => {
                console.log("WebSocket opened:", event);
                gameStatusText.innerText = 'Connected. Waiting for opponent/moves...';
                gameWs.send(JSON.stringify({"type": "request_status"})); // Request current status to sync
            };
            gameWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("WS message:", msg);
                if (msg.type === 'game_start') {
                    gameStatusText.innerText = 'Game started! Make your move!';
                } else if (msg.type === 'move_made') {
                    if (msg.user_id == user.id) {
                         // Your own move confirmed, UI already updated
                    } else {
                        gameStatusText.innerText = 'Opponent made a move!';
                        opponentMove = msg.move; // Store opponent's move if received
                        opponentMoveDisplay.innerText = '?'; // Still hide until game over
                    }
                } else if (msg.type === 'game_status') {
                    // This handles initial state or rejoining
                    if(msg.status === 'active'){
                        gameStatusText.innerText = 'Game active. Make your move!';
                        if (msg.creator_id == user.id && msg.creator_move) playerMove = msg.creator_move;
                        if (msg.opponent_id == user.id && msg.opponent_move) playerMove = msg.opponent_move;
                        
                        // Reflect moves if already made
                        playerMoveDisplay.innerText = (user.id == msg.creator_id) ? getEmoji(msg.creator_move) : getEmoji(msg.opponent_move);
                        opponentMoveDisplay.innerText = (user.id == msg.creator_id) ? (msg.opponent_move ? '?' : '') : (msg.creator_move ? '?' : '');
                        
                        if(playerMove) gameChoices.forEach(btn => btn.classList.add('disabled')); // Disable if already moved
                    } else if (msg.status === 'finished' || msg.status === 'cancelled') {
                        tg.showAlert('Game already finished or cancelled. Check results in chat.');
                        gamePlayModal.style.display = 'none';
                        fetchInitialData();
                    }
                }
                else if (msg.type === 'game_over') {
                    playerMoveDisplay.innerText = (user.id == msg.creator_id) ? getEmoji(msg.creator_move) : getEmoji(msg.opponent_move);
                    opponentMoveDisplay.innerText = (user.id == msg.creator_id) ? getEmoji(msg.opponent_move) : getEmoji(msg.creator_move);

                    if (msg.winner === user.id) {
                        gameStatusText.innerText = `YOU WIN! 🎉`;
                    } else if (msg.winner === -1 || msg.winner === "draw") {
                        gameStatusText.innerText = `IT'S A DRAW! 🤝`;
                    } else {
                        gameStatusText.innerText = `YOU LOSE! 😭`;
                    }
                    gameChoices.forEach(btn => btn.classList.add('disabled')); // Disable choices after game ends
                    setTimeout(() => {
                        gamePlayModal.style.display = 'none';
                        fetchInitialData(); // Refresh balance and rooms
                    }, 3000); // Show result for 3 seconds
                } else if (msg.type === 'error') {
                    tg.showAlert(msg.message);
                    gamePlayModal.style.display = 'none';
                    fetchInitialData();
                }
            };
            gameWs.onclose = (event) => {
                console.log("WebSocket closed:", event);
                if (event.code !== 1000) { // 1000 is normal closure
                    tg.showAlert('Game connection lost. Check bot chat for results.');
                }
                gamePlayModal.style.display = 'none';
                fetchInitialData(); // Refresh UI
            };
            gameWs.onerror = (error) => {
                console.error("WebSocket error:", error);
                tg.showAlert('Game connection error. Please try again.');
                gamePlayModal.style.display = 'none';
                fetchInitialData(); // Refresh UI
            };
        }

        function getEmoji(move) {
            if (move === 'rock') return '✊';
            if (move === 'paper') return '✋';
            if (move === 'scissors') return '✌️';
            return '';
        }
        
    </script>
</body>
</html>